name: policy-ci
permissions:
  contents: read
  actions: read
on:
  push:
    paths:
      - "crates/policy_api/**"
      - "vendor/heimlern-core/**"
      - "vendor/heimlern-bandits/**"
      - ".github/workflows/policy-ci.yml"
  pull_request:
    paths:
      - "crates/policy_api/**"
      - "vendor/heimlern-core/**"
      - "vendor/heimlern-bandits/**"
      - ".github/workflows/policy-ci.yml"
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      RUSTFLAGS: -Dwarnings
    steps:
      - name: Checkout repository
        # Commit pin (matches v4 release) to prevent tag drift and ensure reproducibility
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a96968112b
      - uses: dtolnay/rust-toolchain@3dc12f6bf0c8abca9015ae04963144c46cf9d9b5 # stable snapshot
        with:
          # Explicit input required by dtolnay/rust-toolchain to avoid setup failures.
          toolchain: stable
      - uses: Swatinem/rust-cache@29f7d9a5c8d5a5ca45c8c7c3aa4642f3f7e87b94
        with:
          workspaces: .
      - name: Prepare lockfile (CI-only)
        run: |
          set -euo pipefail
          cargo update -w
      - name: Build (ignore vendor override in CI)
        run: |
          set -euo pipefail
          cargo \
            --config 'net.git-fetch-with-cli = true' \
            build -p hauski-policy-api --no-default-features --verbose
      - name: Smoke test binary starts
        run: |
          set -euo pipefail
          target/debug/policy_api >/dev/null 2>&1 & pid=$!
          sleep 1
          kill $pid || true
