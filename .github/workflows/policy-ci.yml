name: policy-ci
permissions:
  contents: read
  actions: read
on:
  push:
    paths:
      - "crates/policy_api/**"
      - "vendor/heimlern-core/**"
      - "vendor/heimlern-bandits/**"
      - ".github/workflows/policy-ci.yml"
  pull_request:
    paths:
      - "crates/policy_api/**"
      - "vendor/heimlern-core/**"
      - "vendor/heimlern-bandits/**"
      - ".github/workflows/policy-ci.yml"
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      RUSTFLAGS: -Dwarnings
    steps:
      - name: Checkout repository
        # Pin to fixed v4.2.2 release to keep builds deterministic
        uses: actions/checkout@v4.2.2
      - uses: dtolnay/rust-toolchain@stable
        with:
          # Explicit input required by dtolnay/rust-toolchain to avoid setup failures.
          toolchain: stable
      # Pin to fixed v2.6.0 release to keep builds deterministic
      - uses: Swatinem/rust-cache@v2.7.7
        with:
          workspaces: .
      - name: Prepare lockfile (CI-only)
        run: |
          set -euo pipefail
          cargo update -w
      - name: Build (ignore vendor override in CI)
        run: |
          set -euo pipefail
          cargo \
            --config 'net.git-fetch-with-cli = true' \
            build -p hauski-policy-api --no-default-features --verbose
      - name: Smoke test binary starts
        run: |
          set -euo pipefail
          target/debug/policy_api >/dev/null 2>&1 & pid=$!
          sleep 1
          kill $pid || true
