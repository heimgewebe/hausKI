---
name: secret-scan-gitleaks

on:
  push:
    branches: [main]
  pull_request: {}

jobs:
  scan:
    runs-on: ubuntu-latest
    # Minimal nötige Rechte: Code lesen + Security-Events (SARIF) schreiben
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout
        # Pin to fixed v4.2.2 release to keep builds deterministic
        uses: actions/checkout@v4.2.2
        with:
          # Volle History, damit Gitleaks auch alte Commits sieht
          fetch-depth: 0

      - name: Run Gitleaks (wenn Lizenz-Secret vorhanden)
        # Fork-PRs bekommen keine Repo-Secrets; ohne Lizenz-Secret Scan überspringen.
        # Hinweis: Leerer String bei fehlendem Secret führt zu einem Fehlschlag der Action.
        # Die gitleaks-action handhabt fehlende Lizenzen intern.
        uses: gitleaks/gitleaks-action@v2
        with:
          args: "--no-banner"
        env:
          # Für PR-Scanning und SARIF-Upload
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Lizenzschlüssel NICHT ins Repo legen – als Secret in GitHub hinterlegen.
          # Falls nicht vorhanden, wird die Action ohne Lizenz laufen (eingeschränkter Modus).
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
