name: release
on:
  push:
    tags: ['v*.*.*']
permissions:
  contents: write
jobs:
  publish:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2
      - uses: dtolnay/rust-toolchain@3dc12f6bf0c8abca9015ae04963144c46cf9d9b5 # stable snapshot
        with:
          # Explicit input required by dtolnay/rust-toolchain to avoid setup failures.
          toolchain: stable
      - name: Check vendor snapshot
        run: bash scripts/check-vendor.sh
      - name: Build (release, locked)
        run: cargo build --workspace --release --locked
      - name: Package binaries
        run: |
          set -euo pipefail
          mkdir -p dist
          suffix="${{ matrix.os }}"
          tag="${GITHUB_REF_NAME:-}"
          if [ -z "$tag" ]; then
            tag="${GITHUB_REF##*/}"
            if [ -z "$tag" ]; then
              tag="unknown"
            fi
          fi
          for bin in hauski-core hauski-cli; do
            src="target/release/$bin"
            if [ -f "$src" ]; then
              out="dist/${bin}-${tag}-${suffix}"
              cp "$src" "$out"
              strip "$out" || true
            fi
          done
          if [ "$(ls -A dist)" ]; then
            if command -v sha256sum >/dev/null; then
              (cd dist && sha256sum * > "SHA256SUMS-${tag}-${suffix}.txt")
            else
              (cd dist && shasum -a 256 * > "SHA256SUMS-${tag}-${suffix}.txt")
            fi
          fi
      - name: Publish release artifacts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [ ! -d dist ]; then
            echo "No dist directory found; skipping release upload." >&2
            exit 0
          fi

          shopt -s nullglob
          assets=(dist/*)
          shopt -u nullglob

          if [ ${#assets[@]} -eq 0 ]; then
            echo "No artifacts to upload." >&2
            exit 0
          fi

          tag="${GITHUB_REF_NAME:-}"
          if [ -z "$tag" ]; then
            tag="${GITHUB_REF##*/}"
          fi
          if [ -z "$tag" ]; then
            echo "Unable to determine release tag" >&2
            exit 1
          fi

          if gh release view "$tag" >/dev/null 2>&1; then
            gh release upload "$tag" "${assets[@]}" --clobber
          else
            gh release create "$tag" "${assets[@]}" --generate-notes
          fi
