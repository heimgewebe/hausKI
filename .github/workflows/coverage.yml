name: coverage
permissions:
  contents: read
  actions: write

# actions:write is required for rust-cache and upload-artifact to work
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - "crates/**"
      - "Cargo.toml"
      - "Cargo.lock"
      - ".github/workflows/coverage.yml"
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  cov:
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false
    timeout-minutes: 25
    steps:
      - name: Checkout repository
        # Pin to fixed v4.2.2 release to keep builds deterministic
        uses: actions/checkout@v4.2.2
      - uses: dtolnay/rust-toolchain@stable
        with:
          # Explicit input required by dtolnay/rust-toolchain to avoid setup failures.
          toolchain: stable
          components: llvm-tools-preview
      - name: Ensure vendor snapshot
        run: bash scripts/ensure-vendor.sh
      - name: Check vendor snapshot
        run: bash scripts/check-vendor.sh
      - name: Cache cargo + target
        # Pin to a specific release for reproducibility
        uses: Swatinem/rust-cache@v2.7.7
        with:
          cache-on-failure: true
          shared-key: ${{ runner.os }}-cov-${{ hashFiles('**/Cargo.lock') }}
      - name: Install cargo-llvm-cov
        run: cargo install cargo-llvm-cov --locked --version 0.6.9
      - name: Clean coverage profiles
        run: cargo llvm-cov clean --workspace
      - name: Run coverage (focused)
        env:
          # sufficient for llvm-cov; slightly faster than debuginfo=2
          RUSTFLAGS: "-C debuginfo=1"
          CARGO_INCREMENTAL: "0"
          RUST_BACKTRACE: "1"
          CARGO_TERM_COLOR: "always"
        run: |
          # measure only the runtime-relevant crates
          PKGS="--package hauski-core --package hauski-indexd"
          mkdir -p target/coverage/html
          cargo llvm-cov $PKGS --all-features --doctests --fail-under-lines 65 \
            --html --output-path target/coverage/html \
            --lcov --output-path lcov.info
      - name: Upload lcov
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lcov.info
          path: lcov.info
          retention-days: 7
      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html
          path: target/coverage/html
          retention-days: 7
      # Coveralls optional â€“ ein-/auskommentieren je nach Bedarf:
      # - uses: coverallsapp/github-action@v2
      #   with:
      #     github-token: ${{ secrets.GITHUB_TOKEN }}
      #     path-to-lcov: lcov.info
