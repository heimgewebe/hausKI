name: coverage
permissions:
  contents: read
  actions: write # required for rust-cache and upload-artifact

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - "crates/**"
      - "Cargo.toml"
      - "Cargo.lock"
      - ".github/workflows/coverage.yml"
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  cov:
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false
    timeout-minutes: 25

    steps:
      - name: Checkout repository
        # Pin to fixed release for deterministic builds
        uses: actions/checkout@v4.2.2

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: llvm-tools-preview

      - name: Ensure vendor snapshot
        run: bash scripts/ensure-vendor.sh

      - name: Check vendor snapshot
        run: bash scripts/check-vendor.sh

      - name: Cache cargo + target
        # Pin to a specific release for reproducibility
        uses: Swatinem/rust-cache@v2.7.7
        with:
          cache-on-failure: true
          shared-key: ${{ runner.os }}-cov-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-llvm-cov
        run: cargo install cargo-llvm-cov --locked --version 0.6.9

      - name: Clean coverage profiles
        run: cargo llvm-cov clean --workspace

      - name: Run coverage (focused)
        env:
          # slightly faster than debuginfo=2; sufficient for llvm-cov
          RUSTFLAGS: "-C debuginfo=1"
          CARGO_INCREMENTAL: "0"
          RUST_BACKTRACE: "1"
          CARGO_TERM_COLOR: "always"
        run: |
          # measure only the runtime-relevant crates
          PKGS="--package hauski-core --package hauski-indexd"
          echo "PKGS=$PKGS"
          mkdir -p target/coverage/html

          # 1) Erzeuge HTML-Report (inkl. Testlauf)
          cargo llvm-cov $PKGS \
            --all-features \
            --doctests \
            --fail-under-lines 65 \
            --html --output-path target/coverage/html
          echo "HTML report: target/coverage/html/index.html"

          # 2) Erzeuge LCOV-Report aus den bereits gesammelten Profilen
          cargo llvm-cov report \
            --lcov --output-path lcov.info

      - name: Upload HTML coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html
          path: target/coverage/html
          retention-days: 7

      - name: Upload lcov
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lcov.info
          path: lcov.info
          retention-days: 7

      # Coveralls (optional)
      # - uses: coverallsapp/github-action@v2
      #   with:
      #     github-token: ${{ secrets.GITHUB_TOKEN }}
      #     path-to-lcov: lcov.info
