name: CI (smart PR)

# CLASS: baseline
# ------------------------------------------------------------------------------
# This workflow is the Baseline. Other workflows (e.g., heavy.yml, security.yml)
# supplement it, they do not replace it.
# See .github/workflows/README.md for details.
# ------------------------------------------------------------------------------

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened, ready_for_review, labeled, unlabeled]
  merge_group: {}
  workflow_dispatch:
    inputs:
      toolchain:
        description: 'Rust toolchain version to use'
        default: stable
        required: false
  workflow_call:
    inputs:
      toolchain:
        description: 'Rust toolchain version to use'
        required: false
        default: stable
        type: string

env:
  # Provide the toolchain input in both lowercase and uppercase variants so
  # that reusable scripts checking `$toolchain` always receive a value.
  #
  # `inputs.toolchain` is set when this workflow is invoked via workflow_call,
  # `github.event.inputs.toolchain` is set for workflow_dispatch. For all other
  # event types they resolve to an empty
  # string, so the fallback below ensures that CI still uses the stable
  # toolchain by default. The `${{ vars.RUST_TOOLCHAIN }}` check lets repository
  # / organization variables override the default without requiring code
  # changes.
  toolchain: ${{ inputs.toolchain || github.event.inputs.toolchain || vars.RUST_TOOLCHAIN || 'stable' }}
  RUST_TOOLCHAIN: ${{ inputs.toolchain || github.event.inputs.toolchain || vars.RUST_TOOLCHAIN || 'stable' }}

permissions:
  id-token: write
  contents: read
  pull-requests: read

concurrency:
  group: ${{ github.workflow }}-${{ (github.event_name == 'pull_request' && github.event.pull_request.number) || github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      rust:  ${{ steps.filter.outputs.rust }}
      docs:  ${{ steps.filter.outputs.docs }}
      sh:    ${{ steps.filter.outputs.sh }}
    steps:
      - name: Checkout repository
        # Pin to fixed v4.2.2 release to keep builds deterministic
        uses: actions/checkout@v4.2.2
        with:
          ref: ${{ (github.event_name == 'pull_request' && github.event.pull_request.head.sha) || github.sha }}
          fetch-depth: 0
      - name: Fetch main ref explicitly
        # Explicitly fetch origin/main to ensure merge-base operations work correctly.
        # This prevents "fatal: origin/main...HEAD: no merge base" errors in PR contexts.
        run: |
          set -euo pipefail
          git fetch --no-tags --prune origin +refs/heads/main:refs/remotes/origin/main
          echo "Fetched main ref successfully:"
          git show -s --oneline origin/main
          echo "Current HEAD:"
          git show -s --oneline HEAD
      - name: Detect changed paths
        id: filter
        env:
          BASE_REF: ${{ github.base_ref }}
        run: |
          set -euo pipefail

          base_branch="${BASE_REF:-main}"
          if git rev-parse --is-shallow-repository | grep -q true; then
            git fetch --no-tags --no-recurse-submodules --unshallow origin "$base_branch"
          fi
          base_ref="origin/${base_branch}"
          echo "Using base ref: ${base_ref}" >&2

          rust=false
          docs=false
          sh=false

          # Use two-dot diff (git diff base_ref HEAD) instead of three-dot (git diff base_ref...HEAD).
          # This is intentional: in some CI contexts, the merge base may be missing or ambiguous,
          # especially for PRs from forks or with rebased histories. Using two-dot ensures we
          # always compare the current HEAD against the latest base_ref, even if the merge base
          # cannot be resolved. This avoids missing changes due to merge-base issues, at the cost
          # of potentially including extra commits if the branch is not directly based on base_ref.
          #
          # NOTE: We use a while loop with process substitution instead of a pipe to avoid
          # variable assignment in a subshell, which would cause the variables to be lost.
          while IFS= read -r file || [ -n "$file" ]; do
            [ -z "$file" ] && continue
            case "$file" in
              *.rs|Cargo.toml|Cargo.lock)
                rust=true
                ;;
            esac
            case "$file" in
              *.md|docs/*)
                docs=true
                ;;
            esac
            case "$file" in
              *.sh|*.bash|.github/workflows/*)
                sh=true
                ;;
            esac
            if $rust && $docs && $sh; then
              break
            fi
          done < <(git diff --name-only "${base_ref}" HEAD)

          {
            printf 'rust=%s\n' "$rust"
            printf 'docs=%s\n' "$docs"
            printf 'sh=%s\n'   "$sh"
          } >> "$GITHUB_OUTPUT"

  repo-lint:
    name: Repo — Markdown & Shell
    needs: changes
    if: >
      (github.event_name == 'merge_group') ||
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'pull_request' &&
       github.event.pull_request.draft == false &&
       (
         needs.changes.outputs.docs == 'true' ||
         needs.changes.outputs.sh == 'true' ||
         contains(join(github.event.pull_request.labels.*.name), 'full-ci')
       ))
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
      id-token: write
      pull-requests: read
    env:
      RUSTFLAGS: -Dwarnings
    timeout-minutes: 12
    steps:
      - name: Checkout repository
        # Pin to fixed v4.2.2 release to keep builds deterministic
        uses: actions/checkout@v4.2.2
        with:
          ref: ${{ (github.event_name == 'pull_request' && github.event.pull_request.head.sha) || github.sha }}
      - name: Enable Rust problem matchers
        run: echo "::add-matcher::.github/rust.json"
      - name: Normalize toolchain variable
        run: |
          set -euo pipefail
          tc="${RUST_TOOLCHAIN:-}"
          tc="${tc:-stable}"
          echo "Using toolchain: $tc"
          echo "RUST_TOOLCHAIN=$tc" >> "$GITHUB_ENV"
      - uses: dtolnay/rust-toolchain@stable
        with:
          # Explicit input required by dtolnay/rust-toolchain to avoid setup failures.
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          components: rustfmt, clippy
      # Pin to fixed v2.7.7 release for reproducibility
      - uses: Swatinem/rust-cache@v2.7.7
      - name: Check vendor snapshot
        run: bash scripts/check-vendor.sh
      - name: rustfmt (check)
        run: cargo fmt --all --check
      - name: clippy (deny warnings)
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

  shellcheck:
    name: Shell — lint scripts
    needs: changes
    if: >
      (github.event_name == 'merge_group') ||
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'pull_request' &&
       github.event.pull_request.draft == false &&
       (
         needs.changes.outputs.sh == 'true' ||
         contains(join(github.event.pull_request.labels.*.name), 'full-ci')
       ))
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        # Pin to fixed v4.2.2 release to keep builds deterministic
        uses: actions/checkout@v4.2.2
        with:
          ref: ${{ (github.event_name == 'pull_request' && github.event.pull_request.head.sha) || github.sha }}
      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck
      - name: shellcheck
        run: |
          set -euo pipefail

          # Count matching files first to keep the "no files" fast-path
          file_count=$(git ls-files '*.sh' '*.bash' | wc -l)
          if [ "$file_count" -eq 0 ]; then
            echo "No shell scripts to lint"
            exit 0
          fi

          # Exclude:
          # - SC1091: sourced file not present (optional .env files)
          # - SC2034: intentional unused variables (e.g., IFS in scripts/ci-smoke-chat.sh)
          # - SC2015: A && B || C pattern (intentionally used with `|| true` for cleanup)
          # - SC2086: unquoted vars (intentional for $PIDS word splitting in stop-all.sh)
          #
          # Use NUL-delimited paths to handle any special characters in filenames.
          git ls-files -z '*.sh' '*.bash' | xargs -0 -r shellcheck -x --exclude=SC1091,SC2034,SC2015,SC2086

  links:
    name: docs link check (lychee)
    needs: changes
    if: >
      (github.event_name == 'merge_group') ||
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'pull_request' &&
       github.event.pull_request.draft == false &&
       (needs.changes.outputs.docs == 'true' || contains(join(github.event.pull_request.labels.*.name), 'full-ci')))
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
      id-token: write
      pull-requests: read
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        # Pin to fixed v4.2.2 release to keep builds deterministic
        uses: actions/checkout@v4.2.2
        with:
          ref: ${{ (github.event_name == 'pull_request' && github.event.pull_request.head.sha) || github.sha }}
      - uses: lycheeverse/lychee-action@v2.0.2
        with:
          args: >-
            --no-progress
            --verbose
            --retry-wait-time 2
            --max-redirects 5
            --max-retries 2
            --accept 200,204,206,301,302,307,308
            --user-agent "lychee-ci"
            --
            "**/*.md"
      - name: Upload lychee report (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: lychee-report
          path: ./.lycheecache
          if-no-files-found: ignore

  index-budget-gate:
    name: index budget gate
    needs: [changes]
    if: >
      (github.event_name == 'merge_group') ||
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'pull_request' &&
       github.event.pull_request.draft == false &&
       (
         needs.changes.outputs.sh == 'true' ||
         contains(join(github.event.pull_request.labels.*.name), 'full-ci')
       ))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        # Pin to fixed v4.2.2 release to keep builds deterministic
        uses: actions/checkout@v4.2.2
        with:
          ref: ${{ (github.event_name == 'pull_request' && github.event.pull_request.head.sha) || github.sha }}
      - name: Emit TODO notice
        run: echo "index budget gate placeholder"
      - name: Lychee (links)
        if: >-
          github.event_name == 'merge_group' ||
          github.event_name == 'workflow_dispatch' ||
          (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'full-ci'))
        uses: lycheeverse/lychee-action@v2.0.2
        with:
          args: --no-progress --verbose --retry-wait-time 2 --max-redirects 5 -- "**/*.md"

  rust-check:
    name: Rust — fmt & clippy & test
    needs: changes
    if: needs.changes.outputs.rust == 'true' || github.event_name == 'merge_group' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
      id-token: write
      pull-requests: read
    timeout-minutes: 20
    env:
      RUSTFLAGS: -Dwarnings
    steps:
      - name: Checkout repository
        # Pin to fixed v4.2.2 release to keep builds deterministic
        uses: actions/checkout@v4.2.2
        with:
          ref: ${{ (github.event_name == 'pull_request' && github.event.pull_request.head.sha) || github.sha }}
      - name: Enable Rust problem matchers
        run: echo "::add-matcher::.github/rust.json"
      - name: Normalize toolchain variable
        run: |
          set -euo pipefail
          tc="${RUST_TOOLCHAIN:-}"
          tc="${tc:-stable}"
          echo "Using toolchain: $tc"
          echo "RUST_TOOLCHAIN=$tc" >> "$GITHUB_ENV"
      - uses: dtolnay/rust-toolchain@stable
        with:
          # Explicit input required by dtolnay/rust-toolchain to avoid setup failures.
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          components: rustfmt, clippy
      # Pin to fixed v2.7.7 release for reproducibility
      - uses: Swatinem/rust-cache@v2.7.7
      - name: Check vendor snapshot
        run: bash scripts/check-vendor.sh
      - name: Cargo fmt
        run: cargo fmt --all -- --check
      - name: Cargo clippy
        run: cargo clippy --all-targets -- -D warnings
      # Pin to v2 for stability while allowing patch updates
      - uses: taiki-e/install-action@v2
        with:
          tool: nextest
      - name: Tests
        run: |
          if command -v cargo-nextest >/dev/null; then
            cargo nextest run --workspace --all-features --no-fail-fast
          else
            cargo test --workspace --all-features --no-fail-fast
          fi
      - name: Upload target (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: rust-check-target
          path: target
          if-no-files-found: ignore
          retention-days: 7

  health-smoke:
    name: hauski-cli health smoke
    needs: changes
    if: needs.changes.outputs.rust == 'true' || github.event_name == 'merge_group' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
      id-token: write
      pull-requests: read
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        # Pin to fixed v4.2.2 release to keep builds deterministic
        uses: actions/checkout@v4.2.2
        with:
          ref: ${{ (github.event_name == 'pull_request' && github.event.pull_request.head.sha) || github.sha }}
      - name: Normalize toolchain variable
        run: |
          set -euo pipefail
          tc="${RUST_TOOLCHAIN:-}"
          tc="${tc:-stable}"
          echo "Using toolchain: $tc"
          echo "RUST_TOOLCHAIN=$tc" >> "$GITHUB_ENV"
      - uses: dtolnay/rust-toolchain@stable
        with:
          # Explicit input required by dtolnay/rust-toolchain to avoid setup failures.
          toolchain: ${{ env.RUST_TOOLCHAIN }}
      # Pin to fixed v2.7.7 release to keep builds deterministic
      - uses: Swatinem/rust-cache@v2.7.7
      - name: Health & chat smoke (mock ollama)
        run: bash scripts/ci-smoke-chat.sh
  security:
    name: Rust — deny & audit
    needs: changes
    if: >-
      github.event_name == 'merge_group' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'full-ci'))
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        # Pin to fixed v4.2.2 release to keep builds deterministic
        uses: actions/checkout@v4.2.2
        with:
          ref: ${{ (github.event_name == 'pull_request' && github.event.pull_request.head.sha) || github.sha }}
      - name: Normalize toolchain variable
        run: |
          set -euo pipefail
          tc="${RUST_TOOLCHAIN:-}"
          tc="${tc:-stable}"
          echo "Using toolchain: $tc"
          echo "RUST_TOOLCHAIN=$tc" >> "$GITHUB_ENV"
      - uses: dtolnay/rust-toolchain@stable
        with:
          # Explicit input required by dtolnay/rust-toolchain to avoid setup failures.
          toolchain: ${{ env.RUST_TOOLCHAIN }}
      - name: Check vendor snapshot
        run: bash scripts/check-vendor.sh
      # Pin to v2 for stability while allowing patch updates
      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-deny
      - name: cargo deny (advisories/bans/licenses)
        run: |
          cargo deny check advisories
          cargo deny check bans
          cargo deny check licenses
      - uses: rustsec/audit-check@618c2437de90585c33833719fdcddc50271940ad
