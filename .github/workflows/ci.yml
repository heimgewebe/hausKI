name: CI (smart PR)

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened, ready_for_review, labeled, unlabeled]
  merge_group: {}
  workflow_dispatch:
    inputs:
      toolchain:
        description: 'Rust toolchain version to use'
        default: stable
        required: false
  workflow_call:
    inputs:
      toolchain:
        description: 'Rust toolchain version to use'
        required: false
        default: stable
        type: string

env:
  # Provide the toolchain input in both lowercase and uppercase variants so
  # that reusable scripts checking `$toolchain` always receive a value.
  #
  # `inputs.toolchain` is set when this workflow is invoked via workflow_call,
  # `github.event.inputs.toolchain` is set for workflow_dispatch. For all other
  # event types they resolve to an empty
  # string, so the fallback below ensures that CI still uses the stable
  # toolchain by default. The `${{ vars.RUST_TOOLCHAIN }}` check lets repository
  # / organization variables override the default without requiring code
  # changes.
  toolchain: ${{ inputs.toolchain || github.event.inputs.toolchain || vars.RUST_TOOLCHAIN || 'stable' }}
  RUST_TOOLCHAIN: ${{ inputs.toolchain || github.event.inputs.toolchain || vars.RUST_TOOLCHAIN || 'stable' }}

permissions:
  id-token: write
  contents: read
  pull-requests: read

concurrency:
  group: ${{ github.workflow }}-${{ (github.event_name == 'pull_request' && github.event.pull_request.number) || github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      rust:  ${{ steps.filter.outputs.rust }}
      docs:  ${{ steps.filter.outputs.docs }}
      sh:    ${{ steps.filter.outputs.sh }}
    steps:
      - name: Checkout repository
        # Pin to fixed v4.2.2 release to keep builds deterministic
        uses: actions/checkout@v4.2.2
        with:
          ref: ${{ (github.event_name == 'pull_request' && github.event.pull_request.head.sha) || github.sha }}
      - name: Detect changed paths
        id: filter
        env:
          BASE_REF: ${{ github.base_ref }}
        run: |
          set -euo pipefail

          base_branch="${BASE_REF:-main}"
          git fetch --no-tags --depth=1 origin "$base_branch"
          base_ref="origin/${base_branch}"
          echo "Using base ref: ${base_ref}" >&2

          rust=false
          docs=false
          sh=false

          git diff --name-only "${base_ref}"...HEAD | while IFS= read -r file; do
            [ -z "$file" ] && continue
            case "$file" in
              *.rs|Cargo.toml|Cargo.lock)
                rust=true
                ;;
            esac
            case "$file" in
              *.md|docs/*)
                docs=true
                ;;
            esac
            case "$file" in
              *.sh|*.bash|.github/workflows/*)
                sh=true
                ;;
            esac
            if $rust && $docs && $sh; then
              break
            fi
          done

          {
            printf 'rust=%s\n' "$rust"
            printf 'docs=%s\n' "$docs"
            printf 'sh=%s\n'   "$sh"
          } >> "$GITHUB_OUTPUT"

  repo-lint:
    name: Repo — Markdown & Shell
    needs: changes
    if: >
      (github.event_name == 'merge_group') ||
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'pull_request' &&
       github.event.pull_request.draft == false &&
       (
         needs.changes.outputs.docs == 'true' ||
         needs.changes.outputs.sh == 'true' ||
         contains(join(github.event.pull_request.labels.*.name), 'full-ci')
       ))
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
      id-token: write
      pull-requests: read
    env:
      RUSTFLAGS: -Dwarnings
    timeout-minutes: 12
    steps:
      - name: Checkout repository
        # Pin to fixed v4.2.2 release to keep builds deterministic
        uses: actions/checkout@v4.2.2
        with:
          ref: ${{ (github.event_name == 'pull_request' && github.event.pull_request.head.sha) || github.sha }}
      - name: Enable Rust problem matchers
        run: echo "::add-matcher::.github/rust.json"
      - name: Show resolved toolchain
        run: echo "Using toolchain: ${{ env.RUST_TOOLCHAIN || 'stable' }}"
      - uses: dtolnay/rust-toolchain@stable
        with:
          # Explicit input required by dtolnay/rust-toolchain to avoid setup failures.
          # Fall back to "stable" if the workflow-level environment variable is empty.
          toolchain: ${{ env.RUST_TOOLCHAIN || 'stable' }}
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@29f7d9a5c8d5a5ca45c8c7c3aa4642f3f7e87b94
      - name: Check vendor snapshot
        run: bash scripts/check-vendor.sh
      - name: rustfmt (check)
        run: cargo fmt --all --check
      - name: clippy (deny warnings)
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

  shellcheck:
    name: Shell — lint scripts
    needs: changes
    if: >
      (github.event_name == 'merge_group') ||
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'pull_request' &&
       github.event.pull_request.draft == false &&
       (
         needs.changes.outputs.sh == 'true' ||
         contains(join(github.event.pull_request.labels.*.name), 'full-ci')
       ))
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        # Pin to fixed v4.2.2 release to keep builds deterministic
        uses: actions/checkout@v4.2.2
        with:
          ref: ${{ (github.event_name == 'pull_request' && github.event.pull_request.head.sha) || github.sha }}
      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck
      - name: shellcheck
        run: git ls-files '*.sh' '*.bash' | xargs -r shellcheck -x

  links:
    name: docs link check (lychee)
    needs: changes
    if: >
      (github.event_name == 'merge_group') ||
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'pull_request' &&
       github.event.pull_request.draft == false &&
       (needs.changes.outputs.docs == 'true' || contains(join(github.event.pull_request.labels.*.name), 'full-ci')))
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
      id-token: write
      pull-requests: read
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        # Pin to fixed v4.2.2 release to keep builds deterministic
        uses: actions/checkout@v4.2.2
        with:
          ref: ${{ (github.event_name == 'pull_request' && github.event.pull_request.head.sha) || github.sha }}
      - uses: lycheeverse/lychee-action@cc141a2dd1b94f572cca40a6e7d1c2255b21f621
        with:
          args: >-
            --no-progress
            --verbose
            --retry-wait-time 2
            --max-redirects 5
            --max-retries 2
            --accept 200,204,206,301,302,307,308
            --user-agent "lychee-ci"
            --
            "**/*.md"
      - name: Upload lychee report (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: lychee-report
          path: ./.lycheecache
          if-no-files-found: ignore

  index-budget-gate:
    name: index budget gate
    needs: [changes]
    if: >
      (github.event_name == 'merge_group') ||
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'pull_request' &&
       github.event.pull_request.draft == false &&
       (
         needs.changes.outputs.sh == 'true' ||
         contains(join(github.event.pull_request.labels.*.name), 'full-ci')
       ))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        # Pin to fixed v4.2.2 release to keep builds deterministic
        uses: actions/checkout@v4.2.2
        with:
          ref: ${{ (github.event_name == 'pull_request' && github.event.pull_request.head.sha) || github.sha }}
      - name: Emit TODO notice
        run: echo "index budget gate placeholder"
      - name: Lychee (links)
        if: >-
          github.event_name == 'merge_group' ||
          github.event_name == 'workflow_dispatch' ||
          (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'full-ci'))
        uses: lycheeverse/lychee-action@cc141a2dd1b94f572cca40a6e7d1c2255b21f621
        with:
          args: --no-progress --verbose --retry-wait-time 2 --max-redirects 5 -- "**/*.md"

  rust-check:
    name: Rust — fmt & clippy & test
    needs: changes
    if: needs.changes.outputs.rust == 'true' || github.event_name == 'merge_group' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
      id-token: write
      pull-requests: read
    timeout-minutes: 20
    env:
      RUSTFLAGS: -Dwarnings
    steps:
      - name: Checkout repository
        # Pin to fixed v4.2.2 release to keep builds deterministic
        uses: actions/checkout@v4.2.2
        with:
          ref: ${{ (github.event_name == 'pull_request' && github.event.pull_request.head.sha) || github.sha }}
      - name: Enable Rust problem matchers
        run: echo "::add-matcher::.github/rust.json"
      - name: Show resolved toolchain
        run: echo "Using toolchain: ${{ env.RUST_TOOLCHAIN || 'stable' }}"
      - uses: dtolnay/rust-toolchain@stable
        with:
          # Explicit input required by dtolnay/rust-toolchain to avoid setup failures.
          # Fall back to "stable" if the workflow-level environment variable is empty.
          toolchain: ${{ env.RUST_TOOLCHAIN || 'stable' }}
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@29f7d9a5c8d5a5ca45c8c7c3aa4642f3f7e87b94
      - name: Check vendor snapshot
        run: bash scripts/check-vendor.sh
      - name: Cargo fmt
        run: cargo fmt --all -- --check
      - name: Cargo clippy
        run: cargo clippy --all-targets -- -D warnings
      - uses: taiki-e/install-action@7a11182e3a1a996a96f2ef749398a422c9b6f4ff
        with:
          tool: nextest
      - name: Tests
        run: |
          if command -v cargo-nextest >/dev/null; then
            cargo nextest run --workspace --all-features --no-fail-fast
          else
            cargo test --workspace --all-features --no-fail-fast
          fi
      - name: Upload target (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: rust-check-target
          path: target
          if-no-files-found: ignore
          retention-days: 7

  health-smoke:
    name: hauski-cli health smoke
    needs: changes
    if: needs.changes.outputs.rust == 'true' || github.event_name == 'merge_group' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
      id-token: write
      pull-requests: read
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        # Pin to fixed v4.2.2 release to keep builds deterministic
        uses: actions/checkout@v4.2.2
        with:
          ref: ${{ (github.event_name == 'pull_request' && github.event.pull_request.head.sha) || github.sha }}
      - name: Show resolved toolchain
        run: echo "Using toolchain: ${{ env.RUST_TOOLCHAIN || 'stable' }}"
      - uses: dtolnay/rust-toolchain@stable
        with:
          # Fall back to "stable" if the workflow-level environment variable is empty.
          toolchain: ${{ env.RUST_TOOLCHAIN || 'stable' }}
      - uses: Swatinem/rust-cache@29f7d9a5c8d5a5ca45c8c7c3aa4642f3f7e87b94
      - name: Health & chat smoke (mock ollama)
        run: bash scripts/ci-smoke-chat.sh
  security:
    name: Rust — deny & audit
    needs: changes
    if: >-
      github.event_name == 'merge_group' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'full-ci'))
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        # Pin to fixed v4.2.2 release to keep builds deterministic
        uses: actions/checkout@v4.2.2
        with:
          ref: ${{ (github.event_name == 'pull_request' && github.event.pull_request.head.sha) || github.sha }}
      - name: Show resolved toolchain
        run: echo "Using toolchain: ${{ env.RUST_TOOLCHAIN || 'stable' }}"
      - uses: dtolnay/rust-toolchain@stable
        with:
          # Explicit input required by dtolnay/rust-toolchain to avoid setup failures.
          # Fall back to "stable" if the workflow-level environment variable is empty.
          toolchain: ${{ env.RUST_TOOLCHAIN || 'stable' }}
      - name: Check vendor snapshot
        run: bash scripts/check-vendor.sh
      - uses: taiki-e/install-action@7a11182e3a1a996a96f2ef749398a422c9b6f4ff
        with:
          tool: cargo-deny
      - name: cargo deny (advisories/bans/licenses)
        run: |
          cargo deny check advisories
          cargo deny check bans
          cargo deny check licenses
      - uses: rustsec/audit-check@618c2437de90585c33833719fdcddc50271940ad
