name: CI (smart PR)

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened, ready_for_review, labeled, unlabeled]
  merge_group: {}
  workflow_dispatch:
    inputs:
      toolchain:
        description: 'Rust toolchain version to use'
        default: stable
        required: false

env:
  toolchain: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.toolchain != '' && github.event.inputs.toolchain) || 'stable' }}
  RUST_TOOLCHAIN: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.toolchain != '' && github.event.inputs.toolchain) || 'stable' }}

permissions:
  id-token: write
  contents: read
  pull-requests: read

concurrency:
  group: ${{ github.workflow }}-${{ (github.event_name == 'pull_request' && github.event.pull_request.number) || github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      rust:  ${{ steps.filter.outputs.rust }}
      docs:  ${{ steps.filter.outputs.docs }}
      sh:    ${{ steps.filter.outputs.sh }}
    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ (github.event_name == 'pull_request' && github.event.pull_request.head.sha) || github.sha }}
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            rust:
              - '**/*.rs'
              - 'Cargo.toml'
              - 'Cargo.lock'
            docs:
              - '**/*.md'
              - 'docs/**'
            sh:
              - '**/*.sh'
              - '.github/workflows/**'

  repo-lint:
    name: Repo — Markdown & Shell
    needs: changes
    if: >
      (github.event_name == 'merge_group') ||
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'pull_request' &&
       github.event.pull_request.draft == false &&
       (
         needs.changes.outputs.docs == 'true' ||
         needs.changes.outputs.sh == 'true' ||
         contains(join(github.event.pull_request.labels.*.name), 'full-ci')
       ))
    runs-on: ubuntu-latest
    env:
      RUSTFLAGS: -Dwarnings
    timeout-minutes: 12
    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ (github.event_name == 'pull_request' && github.event.pull_request.head.sha) || github.sha }}
      - name: Enable Rust problem matchers
        run: echo "::add-matcher::.github/rust.json"
      - uses: dtolnay/rust-toolchain@stable
        with:
          # Explicit input required by dtolnay/rust-toolchain to avoid setup failures.
          toolchain: ${{ env.toolchain }}
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2
      - name: Check vendor snapshot
        run: bash scripts/check-vendor.sh
      - name: rustfmt (check)
        run: cargo fmt --all --check
      - name: clippy (deny warnings)
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

  links:
    name: docs link check (lychee)
    needs: changes
    if: >
      (github.event_name == 'merge_group') ||
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'pull_request' &&
       github.event.pull_request.draft == false &&
       (needs.changes.outputs.docs == 'true' || contains(join(github.event.pull_request.labels.*.name), 'full-ci')))
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ (github.event_name == 'pull_request' && github.event.pull_request.head.sha) || github.sha }}
      - uses: lycheeverse/lychee-action@v2
        with:
          args: >-
            --no-progress
            --verbose
            --retry-wait-time 2
            --max-redirects 5
            --max-retries 2
            --accept 200,204,206,301,302,307,308
            --user-agent "lychee-ci"
            --
            "**/*.md"
      - name: Upload lychee report (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: lychee-report
          path: ./.lycheecache
          if-no-files-found: ignore

  index-budget-gate:
    name: index budget gate
    needs: [changes]
    if: >
      (github.event_name == 'merge_group') ||
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'pull_request' &&
       github.event.pull_request.draft == false &&
       (
         needs.changes.outputs.sh == 'true' ||
         contains(join(github.event.pull_request.labels.*.name), 'full-ci')
       ))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ (github.event_name == 'pull_request' && github.event.pull_request.head.sha) || github.sha }}
      - name: Emit TODO notice
        run: |
          sudo apt-get update && sudo apt-get install -y shellcheck
          git ls-files '*.sh' | xargs -r shellcheck -x
      - name: Lychee (links)
        if: >-
          github.event_name == 'merge_group' ||
          github.event_name == 'workflow_dispatch' ||
          (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'full-ci'))
        uses: lycheeverse/lychee-action@v2
        with:
          args: --no-progress --verbose --retry-wait-time 2 --max-redirects 5 -- "**/*.md"

  rust-check:
    name: Rust — fmt & clippy & test
    needs: changes
    if: needs.changes.outputs.rust == 'true' || github.event_name == 'merge_group' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      RUSTFLAGS: -Dwarnings
    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ (github.event_name == 'pull_request' && github.event.pull_request.head.sha) || github.sha }}
      - name: Enable Rust problem matchers
        run: echo "::add-matcher::.github/rust.json"
      - uses: dtolnay/rust-toolchain@stable
        with:
          # Explicit input required by dtolnay/rust-toolchain to avoid setup failures.
          toolchain: ${{ env.toolchain }}
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2
      - name: Check vendor snapshot
        run: bash scripts/check-vendor.sh
      - name: Cargo fmt
        run: cargo fmt --all -- --check
      - name: Cargo clippy
        run: cargo clippy --all-targets -- -D warnings
      - uses: taiki-e/install-action@v2
        with:
          tool: nextest
      - name: Tests
        run: |
          if command -v cargo-nextest >/dev/null; then
            cargo nextest run --workspace --all-features --no-fail-fast
          else
            cargo test --workspace --all-features --no-fail-fast
          fi
      - name: Upload target (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: rust-check-target
          path: target
          if-no-files-found: ignore
          retention-days: 7

  health-smoke:
    name: hauski-cli health smoke
    needs: changes
    if: needs.changes.outputs.rust == 'true' || github.event_name == 'merge_group' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ (github.event_name == 'pull_request' && github.event.pull_request.head.sha) || github.sha }}
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.toolchain }}
      - uses: Swatinem/rust-cache@v2
      - name: Build hauski-cli
        run: cargo build -p hauski-cli
      - name: Health smoke
        run: |
          set -euo pipefail
          cargo run -p hauski-cli -- serve &
          pid=$!
          trap 'kill "$pid" 2>/dev/null || true' EXIT
          sleep 1
          curl -sf http://127.0.0.1:8080/healthz
          kill "$pid"
          wait "$pid" || true
          trap - EXIT
  security:
    name: Rust — deny & audit
    needs: changes
    if: >-
      github.event_name == 'merge_group' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'full-ci'))
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ (github.event_name == 'pull_request' && github.event.pull_request.head.sha) || github.sha }}
      - uses: dtolnay/rust-toolchain@stable
        with:
          # Explicit input required by dtolnay/rust-toolchain to avoid setup failures.
          toolchain: ${{ env.toolchain }}
      - name: Check vendor snapshot
        run: bash scripts/check-vendor.sh
      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-deny
      - name: cargo deny (advisories/bans/licenses)
        run: |
          cargo deny check advisories
          cargo deny check bans
          cargo deny check licenses
      - uses: rustsec/audit-check@v2
