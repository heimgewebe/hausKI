name: CI (tools)

on:
  pull_request:
    branches:
      - main
    paths:
      - 'pyproject.toml'
      - 'uv.lock'
      - '**/*.py'
      - 'docs/**'
      - 'mkdocs.yml'
      - '.github/workflows/ci-tools.yml'
  workflow_dispatch: {}

permissions:
  actions: write
  contents: read

jobs:
  tools:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout repository
        # Pin to fixed v4.2.2 release to keep builds deterministic
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0

      # --- uv bootstrap -------------------------------------------------------
      - name: Install uv
        if: ${{ hashFiles('pyproject.toml') != '' }}
        run: |
          set -euo pipefail
          # Installiere die neueste verfügbare uv-Version (Installer erwartet exakte Tags, daher ohne Wildcard)
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          # Für diesen Step PATH sofort setzen und auf exakt 0.7.6 pinnen
          export PATH="$HOME/.local/bin:$HOME/.cargo/bin:$PATH"
          uv --version || true
          uv self update 0.7.6

      - name: Ensure uv version (expect 0.7.6)
        if: ${{ hashFiles('pyproject.toml') != '' }}
        run: |
          set -euo pipefail
          export PATH="$HOME/.local/bin:$HOME/.cargo/bin:$PATH"
          version="$(uv --version)"
          echo "$version"
          grep -E '^uv 0\.7\.6$' <<<"$version"

      # --- Sanity check: lock must exist and be in sync for dev extra ----------
      - name: Check uv.lock presence
        if: ${{ hashFiles('pyproject.toml') != '' }}
        run: |
          test -f uv.lock || { echo "Missing uv.lock. Run locally: uv lock --extra dev"; exit 1; }

      - name: Assert jsonschema pinned in uv.lock
        if: ${{ hashFiles('pyproject.toml') != '' }}
        run: |
          python3 - <<'PY'
          from __future__ import annotations

          import json
          import sys
          from pathlib import Path

          lock_path = Path("uv.lock")
          if not lock_path.exists():
            print("uv.lock not found. Run: uv lock --extra dev", file=sys.stderr)
            sys.exit(1)

          raw_text = lock_path.read_text(encoding="utf-8")

          def has_jsonschema_from_toml() -> bool:
            try:
              try:
                import tomllib  # type: ignore[attr-defined]
              except ModuleNotFoundError:
                import tomli as tomllib  # type: ignore[no-redef]
            except ModuleNotFoundError:
              return False

            try:
              data = tomllib.loads(raw_text)
            except Exception:
              return False

            packages = data.get("package", [])
            for package in packages:
              name = package.get("name")
              if isinstance(name, str) and name.lower() == "jsonschema":
                return True
            return False

          def has_jsonschema_from_json() -> bool:
            try:
              data = json.loads(raw_text)
            except json.JSONDecodeError:
              return False
            packages = data.get("package", [])
            for package in packages:
              name = package.get("name")
              if isinstance(name, str) and name.lower() == "jsonschema":
                return True
            return False

          def has_jsonschema_from_text() -> bool:
            lowered = raw_text.lower()
            return 'name = "jsonschema"' in lowered or '"name": "jsonschema"' in lowered

          if not (
              has_jsonschema_from_toml()
              or has_jsonschema_from_json()
              or has_jsonschema_from_text()
          ):
            print("jsonschema not found in uv.lock.")
            print("Fix locally:")
            print("  uv lock --upgrade-package jsonschema==4.23.0")
            print("  # oder gesamtes Dev-Set refreshen: uv lock --extra dev")
            sys.exit(1)
          PY

      - name: Cache uv
        if: ${{ hashFiles('pyproject.toml') != '' }}
        uses: actions/cache@v4.0.2
        with:
          path: |
            ~/.cache/uv
            ~/.local/share/uv
          key: ${{ runner.os }}-uv-${{ hashFiles('pyproject.toml', 'uv.lock', 'mkdocs.yml') }}
          restore-keys: |
            ${{ runner.os }}-uv-${{ hashFiles('pyproject.toml', 'uv.lock') }}-
            ${{ runner.os }}-uv-

      - name: Sync dev deps (locked & frozen)
        if: ${{ hashFiles('pyproject.toml') != '' }}
        run: uv sync --extra dev --locked --frozen

      - name: Show Ruff version
        if: ${{ hashFiles('pyproject.toml') != '' }}
        run: uv run ruff --version

      - name: Show MkDocs version
        if: ${{ hashFiles('pyproject.toml') != '' }}
        run: uv run mkdocs --version

      - name: Ruff check
        if: ${{ hashFiles('pyproject.toml') != '' }}
        run: uv run ruff check .

      - name: Validate JSON Schemas
        if: ${{ hashFiles('pyproject.toml') != '' }}
        run: uv run python scripts/validate-jsonschemas.py

      - name: Pytests
        if: ${{ hashFiles('pyproject.toml') != '' }}
        run: |
          set -euo pipefail
          if [ -f "pytest.ini" ] || [ -d "tests" ] || ls tests_*.py 1> /dev/null 2>&1; then
            uv run pytest -q
          else
            echo "No Python tests – skipping."
          fi

      - name: Build docs
        if: ${{ hashFiles('pyproject.toml') != '' }}
        run: |
          set -euo pipefail
          if [ -f "mkdocs.yml" ]; then
            uv run mkdocs build --strict --clean
          else
            echo "No mkdocs.yml – skipping."
          fi
