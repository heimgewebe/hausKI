# CLASS: baseline
name: CI (tools)

on:
  pull_request:
    branches:
      - main
    paths:
      - 'pyproject.toml'
      - 'uv.lock'
      - '**/*.py'
      - 'docs/**'
      - 'mkdocs.yml'
      - '.github/workflows/ci-tools.yml'
  workflow_dispatch: {}

permissions:
  actions: write
  contents: read

jobs:
  tools:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout repository
        # Pin to fixed v4.2.2 release to keep builds deterministic
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0

      # --- uv bootstrap -------------------------------------------------------
      - name: Install uv
        if: ${{ hashFiles('pyproject.toml') != '' }}
        run: |
          set -euo pipefail
          # Installiere die neueste verfügbare uv-Version (Installer erwartet exakte Tags, daher ohne Wildcard)
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          # Für diesen Step PATH sofort setzen und aktuelle stabile Version verwenden
          export PATH="$HOME/.local/bin:$HOME/.cargo/bin:$PATH"
          uv --version || true
          # Version 0.7.6 ist nicht mehr verfügbar, nutze aktuelle stabile Version
          uv self update

      - name: Ensure uv version (current stable)
        if: ${{ hashFiles('pyproject.toml') != '' }}
        run: |
          set -euo pipefail
          export PATH="$HOME/.local/bin:$HOME/.cargo/bin:$PATH"
          version="$(uv --version)"
          echo "Using uv version: $version"

      # --- Sanity check: lock must exist and be in sync for dev extra ----------
      - name: Diagnose CI Workspace (pre-sanity)
        if: ${{ hashFiles('pyproject.toml') != '' }}
        run: |
          echo "Current working directory: $(pwd)"
          echo "Repository root listing:"
          ls -la
          echo "Full tree listing (depth 2):"
          ls -R | head -n 100

      - name: Sanity - require uv.lock when schema sources exist
        if: ${{ hashFiles('pyproject.toml') != '' }}
        shell: bash
        run: |
          python3 - <<'PYTHON_SCRIPT'
          import os
          import sys


          def has_jsonschema_from_toml():
              return os.path.exists("pyproject.toml")


          def has_jsonschema_from_json():
              return os.path.exists("package.json") or os.path.exists("contracts/schema.json")


          def has_jsonschema_from_text():
              # Platzhalter für spätere Textquellen (README-Anker etc.)
              return False


          ok = (
              has_jsonschema_from_toml()
              or has_jsonschema_from_json()
              or has_jsonschema_from_text()
          )
          # Wenn keine Schema-Quelle vorhanden ist, überspringen wir die Lock-Prüfung.
          if not ok:
              print("No schema source detected; skipping uv.lock check")
              sys.exit(0)
          # Liegt eine Schema-Quelle vor, MUSS uv.lock existieren.
          if not os.path.exists("uv.lock"):
              print("uv.lock not found. Run uv lock --extra dev", file=sys.stderr)
              sys.exit(1)
          PYTHON_SCRIPT

      - name: Assert jsonschema pinned in uv.lock
        if: ${{ hashFiles('pyproject.toml') != '' }}
        run: |
          python3 - <<'PYTHON_SCRIPT'
          from __future__ import annotations

          import json
          import sys
          from pathlib import Path

          lock_path = Path("uv.lock")
          if not lock_path.exists():
              print("uv.lock not found. Run: uv lock --extra dev", file=sys.stderr)
              sys.exit(1)

          raw_text = lock_path.read_text(encoding="utf-8")

          def has_jsonschema_from_toml():
              try:
                  try:
                      import tomllib
                  except ModuleNotFoundError:
                      import tomli as tomllib
              except ModuleNotFoundError:
                  return False

              try:
                  data = tomllib.loads(raw_text)
              except Exception:
                  return False

              packages = data.get("package", [])
              for package in packages:
                  name = package.get("name")
                  if isinstance(name, str) and name.lower() == "jsonschema":
                      return True
              return False

          def has_jsonschema_from_json():
              try:
                  data = json.loads(raw_text)
              except json.JSONDecodeError:
                  return False
              packages = data.get("package", [])
              for package in packages:
                  name = package.get("name")
                  if isinstance(name, str) and name.lower() == "jsonschema":
                      return True
              return False

          def has_jsonschema_from_text():
              lowered = raw_text.lower()
              return 'name = "jsonschema"' in lowered or '"name": "jsonschema"' in lowered

          if not (
              has_jsonschema_from_toml()
              or has_jsonschema_from_json()
              or has_jsonschema_from_text()
          ):
              print("jsonschema not found in uv.lock.")
              print("Fix locally:")
              print("  uv lock --upgrade-package jsonschema==4.23.0")
              print("  # oder gesamtes Dev-Set refreshen: uv lock --extra dev")
              sys.exit(1)
          PYTHON_SCRIPT

      - name: Cache uv
        if: ${{ hashFiles('pyproject.toml') != '' }}
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            ~/.local/share/uv
            ~/Library/Caches/uv
            ~/Library/Application Support/uv
            ~\AppData\Local\uv\Cache
            ~\AppData\Roaming\uv
          key: ${{ runner.os }}-uv-${{ hashFiles('pyproject.toml', 'uv.lock', 'mkdocs.yml') }}
          restore-keys: |
            ${{ runner.os }}-uv-${{ hashFiles('pyproject.toml', 'uv.lock') }}-
            ${{ runner.os }}-uv-

      - name: Sync dev deps (frozen)
        if: ${{ hashFiles('pyproject.toml') != '' }}
        run: uv sync --extra dev --frozen

      - name: Show Ruff version
        if: ${{ hashFiles('pyproject.toml') != '' }}
        run: uv run ruff --version

      - name: Show MkDocs version
        if: ${{ hashFiles('pyproject.toml') != '' }}
        run: uv run mkdocs --version

      - name: Ruff check
        if: ${{ hashFiles('pyproject.toml') != '' }}
        run: uv run ruff check .

      - name: Validate JSON Schemas
        if: ${{ hashFiles('pyproject.toml') != '' }}
        run: uv run python scripts/validate-jsonschemas.py

      - name: Validate event sample against schema
        if: ${{ hashFiles('pyproject.toml') != '' }}
        run: |
          set -euo pipefail
          uv run python - <<'PYTHON_SCRIPT'
          import json
          from pathlib import Path

          from jsonschema import Draft202012Validator, validate


          root = Path('.')
          schema = json.loads((root / 'contracts' / 'events.schema.json').read_text(encoding='utf-8'))
          sample = json.loads((root / 'contracts' / 'examples' / 'event.sample.json').read_text(encoding='utf-8'))

          Draft202012Validator.check_schema(schema)
          validate(sample, schema)
          print('contracts/examples/event.sample.json ✓')
          PYTHON_SCRIPT

      - name: Pytests
        if: ${{ hashFiles('pyproject.toml') != '' }}
        run: |
          set -euo pipefail
          if [ -f "pytest.ini" ] || [ -d "tests" ] || ls tests_*.py 1> /dev/null 2>&1; then
            uv run pytest -q
          else
            echo "No Python tests – skipping."
          fi

      - name: Build docs
        if: ${{ hashFiles('pyproject.toml') != '' }}
        run: |
          set -euo pipefail
          if [ -f "mkdocs.yml" ]; then
            uv run mkdocs build --strict --clean
          else
            echo "No mkdocs.yml – skipping."
          fi
